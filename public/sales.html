<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penjualan - Sistem Koperasi</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="assets/css/all.min.css">
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-store"></i> Koperasi</h2>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li><a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="customers.html"><i class="fas fa-users"></i> Customer</a></li>
                <li><a href="items.html"><i class="fas fa-box"></i> Item</a></li>
                <li><a href="staff.html"><i class="fas fa-user-tie"></i> Petugas</a></li>
                <li><a href="sales.html"><i class="fas fa-shopping-cart"></i> Penjualan</a></li>
            </ul>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>Manajemen Penjualan</h1>
            </div>
            <div class="header-right">
                <div class="user-info">
                </div>
            </div>
        </header>

        <!-- Content -->
        <main class="content">
            <!-- Sales List Card -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-shopping-cart"></i> Daftar Penjualan</h3>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary no-print" onclick="printSales()">
                            <i class="fas fa-print"></i> Print
                        </button>
                        <button class="btn btn-primary no-print" onclick="showAddSaleModal()">
                            <i class="fas fa-plus"></i> Buat Penjualan Baru
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="salesTable">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin"></i> Memuat data...
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Sale Modal -->
    <div id="saleModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h4 id="modalTitle">Buat Penjualan Baru</h4>
                <button class="close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="saleForm">
                    <input type="hidden" id="saleId" name="id">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="tgl_sales" class="form-label">Tanggal Penjualan</label>
                            <input type="datetime-local" id="tgl_sales" name="tgl_sales" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="id_customer" class="form-label">Customer</label>
                            <select id="id_customer" name="id_customer" class="form-control" required>
                                <option value="">Pilih Customer</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="UIUtils.hideModal('saleModal')">Batal</button>
                <button type="submit" form="saleForm" class="btn btn-primary" id="saveBtn">
                    <i class="fas fa-save"></i> Simpan
                </button>
            </div>
        </div>
    </div>

    <!-- Sale Detail Modal -->
    <div id="saleDetailModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h4 id="detailModalTitle">Detail Penjualan</h4>
                <button class="close">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Sale Info -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle"></i> Informasi Penjualan</h5>
                    </div>
                    <div class="card-body">
                        <div id="saleInfo">
                        </div>
                    </div>
                </div>

                <!-- Add Transaction -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5><i class="fas fa-plus"></i> Tambah Item</h5>
                    </div>
                    <div class="card-body">
                        <form id="transactionForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="id_item" class="form-label">Item</label>
                                    <select id="id_item" name="id_item" class="form-control" required>
                                        <option value="">Pilih Item</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="quantity" class="form-label">Quantity</label>
                                    <input type="number" id="quantity" name="quantity" class="form-control" min="1" step="1" value="1" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="price" class="form-label">Harga Satuan</label>
                                    <input type="number" id="price" name="price" class="form-control" min="0" step="1" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Total Harga</label>
                                <div class="form-control" style="background-color: #f8f9fa;" id="totalPrice">
                                    Rp 0
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-plus"></i> Tambah ke Keranjang
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Transaction List -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-list"></i> Daftar Item</h5>
                    </div>
                    <div class="card-body">
                        <div id="transactionsTable">
                            <div class="text-center">Belum ada item</div>
                        </div>
                        
                        <div class="mt-3 d-flex justify-content-between align-items-center">
                            <strong>Total Penjualan: </strong>
                            <strong id="grandTotal" style="font-size: 1.2em; color: #667eea;">Rp 0</strong>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary no-print" onclick="UIUtils.hideModal('saleDetailModal')">Tutup</button>
                <button type="button" class="btn btn-primary no-print" onclick="printSaleDetail()">
                    <i class="fas fa-print"></i> Cetak Detail
                </button>
            </div>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script>
        // Sales management class
        class SalesManager {
            constructor() {
                this.sales = [];
                this.customers = [];
                this.items = [];
                this.currentSaleId = null;
                this.currentTransactions = [];
                this.init();
            }

            async init() {
                await this.loadData();
                this.initEventListeners();
            }

            async loadData() {
                try {
                    // Load all required data
                    const [sales, customers, items] = await Promise.all([
                        ApiUtils.get('/sales'),
                        ApiUtils.get('/customer'),
                        ApiUtils.get('/item')
                    ]);

                    this.sales = sales || [];
                    this.customers = customers || [];
                    this.items = items || [];

                    this.populateCustomerSelect();
                    this.populateItemSelect();
                    this.renderSalesTable();
                } catch (error) {
                    console.error('Error loading data:', error);
                    UIUtils.showError('Gagal memuat data');
                }
            }

            initEventListeners() {
                // Sale form submission
                document.getElementById('saleForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveSale();
                });

                // Transaction form submission
                document.getElementById('transactionForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addTransaction();
                });

                // Calculate total when quantity or price changes
                const quantity = document.getElementById('quantity');
                const price = document.getElementById('price');
                
                quantity.addEventListener('input', () => this.calculateTransactionTotal());
                price.addEventListener('input', () => this.calculateTransactionTotal());

                // Auto-fill price when item is selected
                document.getElementById('id_item').addEventListener('change', (e) => {
                    const itemId = parseInt(e.target.value);
                    if (itemId) {
                        const item = this.items.find(i => i.id === itemId);
                        if (item) {
                            document.getElementById('price').value = item.harga_jual;
                            this.calculateTransactionTotal();
                        }
                    }
                });

                // Set default date to now
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('tgl_sales').value = now.toISOString().slice(0, 16);
            }

            populateCustomerSelect() {
                const select = document.getElementById('id_customer');
                select.innerHTML = '<option value="">Pilih Customer</option>';
                
                this.customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = `${customer.nama} - ${customer.email}`;
                    select.appendChild(option);
                });
            }

            populateItemSelect() {
                const select = document.getElementById('id_item');
                select.innerHTML = '<option value="">Pilih Item</option>';
                
                this.items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = `${item.nama_item} (${item.uom}) - ${UIUtils.formatCurrency(item.harga_jual)}`;
                    select.appendChild(option);
                });
            }

            calculateTransactionTotal() {
                const quantity = parseFloat(document.getElementById('quantity').value) || 0;
                const price = parseFloat(document.getElementById('price').value) || 0;
                const total = quantity * price;
                
                document.getElementById('totalPrice').textContent = UIUtils.formatCurrency(total);
            }

            renderSalesTable() {
                const columns = [
                    { field: 'id', title: 'ID' },
                    { 
                        field: 'tgl_sales', 
                        title: 'Tanggal',
                        render: (value) => UIUtils.formatDateTime(value)
                    },
                    { 
                        field: 'customer', 
                        title: 'Customer',
                        render: (value) => value?.nama || 'N/A'
                    },
                    {
                        field: 'actions',
                        title: 'Aksi',
                        render: (value, row) => `
                            <div class="actions">
                                <button class="btn btn-sm btn-success" onclick="salesManager.viewSaleDetail(${row.id})">
                                    <i class="fas fa-eye"></i> Detail
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="salesManager.editSale(${row.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="salesManager.deleteSale(${row.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `
                    }
                ];

                TableUtils.renderTable('salesTable', this.sales, columns);
            }

            async saveSale() {
                const form = document.getElementById('saleForm');
                
                if (!FormUtils.validate(form)) {
                    UIUtils.showError('Harap lengkapi semua field yang diperlukan');
                    return;
                }

                const data = FormUtils.serialize(form);
                
                try {
                    // Show loading
                    const saveBtn = document.getElementById('saveBtn');
                    const originalText = saveBtn.innerHTML;
                    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
                    saveBtn.disabled = true;

                    let response;
                    if (this.currentSaleId) {
                        // Update existing sale
                        response = await ApiUtils.put(`/sales/${this.currentSaleId}`, data);
                    } else {
                        // Create new sale
                        response = await ApiUtils.post('/sales', data);
                    }

                    if (response && response.data) {
                        UIUtils.showSuccess(this.currentSaleId ? 'Penjualan berhasil diperbarui' : 'Penjualan berhasil dibuat');
                        UIUtils.hideModal('saleModal');
                        
                        // If new sale, show detail modal
                        if (!this.currentSaleId) {
                            this.viewSaleDetail(response.data.id);
                        }
                        
                        this.resetSaleForm();
                        await this.loadData();
                    }
                } catch (error) {
                    console.error('Error saving sale:', error);
                    UIUtils.showError('Gagal menyimpan penjualan');
                } finally {
                    // Reset button
                    const saveBtn = document.getElementById('saveBtn');
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Simpan';
                    saveBtn.disabled = false;
                }
            }

            async viewSaleDetail(saleId) {
                try {
                    this.currentSaleId = saleId;
                    
                    // Get sale details
                    const sale = this.sales.find(s => s.id === saleId);
                    if (!sale) return;

                    // Populate sale info
                    const customer = sale.customer;
                    document.getElementById('saleInfo').innerHTML = `
                        <div class="form-row">
                            <div class="form-group">
                                <strong>ID Penjualan:</strong> ${sale.id}
                            </div>
                            <div class="form-group">
                                <strong>Tanggal:</strong> ${UIUtils.formatDateTime(sale.tgl_sales)}
                            </div>
                        </div>
                        <div class="form-group">
                            <strong>Customer:</strong> ${customer?.nama || 'N/A'} (${customer?.email || 'N/A'})
                        </div>
                    `;

                    // Load transactions
                    await this.loadTransactions(saleId);
                    
                    UIUtils.showModal('saleDetailModal');
                } catch (error) {
                    console.error('Error viewing sale detail:', error);
                    UIUtils.showError('Gagal memuat detail penjualan');
                }
            }

            async loadTransactions(saleId) {
                try {
                    // Get sale with transactions
                    const sale = await ApiUtils.get(`/sales/${saleId}`);
                    this.currentTransactions = sale?.transaction || [];
                    
                    this.renderTransactionsTable();
                    this.calculateGrandTotal();
                } catch (error) {
                    console.error('Error loading transactions:', error);
                    this.currentTransactions = [];
                    this.renderTransactionsTable();
                }
            }

            renderTransactionsTable() {
                if (this.currentTransactions.length === 0) {
                    document.getElementById('transactionsTable').innerHTML = 
                        '<div class="text-center">Belum ada item</div>';
                    return;
                }

                const columns = [
                    { 
                        field: 'Item', 
                        title: 'Item',
                        render: (value) => value?.nama_item || 'N/A'
                    },
                    { field: 'quantity', title: 'Qty' },
                    { 
                        field: 'price', 
                        title: 'Harga Satuan',
                        render: (value) => UIUtils.formatCurrency(value)
                    },
                    {
                        field: 'total',
                        title: 'Total',
                        render: (value, row) => UIUtils.formatCurrency(row.quantity * row.price)
                    },
                    {
                        field: 'actions',
                        title: 'Aksi',
                        render: (value, row) => `
                            <div class="actions">
                                <button class="btn btn-sm btn-warning" onclick="salesManager.editTransaction(${row.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="salesManager.deleteTransaction(${row.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `
                    }
                ];

                TableUtils.renderTable('transactionsTable', this.currentTransactions, columns);
            }

            calculateGrandTotal() {
                const total = this.currentTransactions.reduce((sum, transaction) => {
                    return sum + (transaction.quantity * transaction.price);
                }, 0);
                
                document.getElementById('grandTotal').textContent = UIUtils.formatCurrency(total);
            }

            async addTransaction() {
                const form = document.getElementById('transactionForm');
                
                if (!FormUtils.validate(form)) {
                    UIUtils.showError('Harap lengkapi semua field');
                    return;
                }

                const data = FormUtils.serialize(form);
                
                try {
                    const response = await ApiUtils.post(`/sales/${this.currentSaleId}/transactions`, data);
                    
                    if (response) {
                        UIUtils.showSuccess('Item berhasil ditambahkan');
                        FormUtils.reset(form);
                        document.getElementById('quantity').value = 1;
                        document.getElementById('totalPrice').textContent = 'Rp 0';
                        await this.loadTransactions(this.currentSaleId);
                    }
                } catch (error) {
                    console.error('Error adding transaction:', error);
                    UIUtils.showError('Gagal menambahkan item');
                }
            }

            async deleteTransaction(transactionId) {
                if (!UIUtils.confirmDelete('Hapus item ini dari penjualan?')) {
                    return;
                }

                try {
                    await ApiUtils.delete(`/sales/${this.currentSaleId}/transactions/${transactionId}`);
                    UIUtils.showSuccess('Item berhasil dihapus');
                    await this.loadTransactions(this.currentSaleId);
                } catch (error) {
                    console.error('Error deleting transaction:', error);
                    UIUtils.showError('Gagal menghapus item');
                }
            }

            editSale(id) {
                const sale = this.sales.find(s => s.id === id);
                if (!sale) return;

                this.currentSaleId = id;
                document.getElementById('modalTitle').textContent = 'Edit Penjualan';
                
                const form = document.getElementById('saleForm');
                FormUtils.populate(form, sale);
                
                // Format datetime for input
                const date = new Date(sale.tgl_sales);
                date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
                document.getElementById('tgl_sales').value = date.toISOString().slice(0, 16);
                
                UIUtils.showModal('saleModal');
            }

            async deleteSale(id) {
                const sale = this.sales.find(s => s.id === id);
                if (!sale) return;

                if (!UIUtils.confirmDelete(`Hapus penjualan #${id}?`)) {
                    return;
                }

                try {
                    await ApiUtils.delete(`/sales/${id}`);
                    UIUtils.showSuccess('Penjualan berhasil dihapus');
                    await this.loadData();
                } catch (error) {
                    console.error('Error deleting sale:', error);
                    UIUtils.showError('Gagal menghapus penjualan');
                }
            }

            resetSaleForm() {
                this.currentSaleId = null;
                document.getElementById('modalTitle').textContent = 'Buat Penjualan Baru';
                FormUtils.reset(document.getElementById('saleForm'));
                
                // Reset date to now
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('tgl_sales').value = now.toISOString().slice(0, 16);
            }
        }

        // Global functions
        function showAddSaleModal() {
            salesManager.resetSaleForm();
            UIUtils.showModal('saleModal');
        }

        function printSales() {
            // Add print header
            const printHeader = document.createElement('div');
            printHeader.className = 'print-header';
            printHeader.innerHTML = `
                <h1>Sistem Koperasi - Daftar Penjualan</h1>
                <p>Tanggal: ${new Date().toLocaleDateString('id-ID')}</p>
            `;
            
            // Add print footer
            const printFooter = document.createElement('div');
            printFooter.className = 'print-footer';
            printFooter.innerHTML = `
                <p>Total Penjualan: ${salesManager.sales.length}</p>
                <p>Dicetak pada: ${new Date().toLocaleString('id-ID')}</p>
            `;
            
            // Insert elements
            const content = document.querySelector('.content');
            content.insertBefore(printHeader, content.firstChild);
            content.appendChild(printFooter);
            
            // Print
            window.print();
            
            // Remove print elements after printing
            setTimeout(() => {
                printHeader.remove();
                printFooter.remove();
            }, 1000);
        }

        function printSaleDetail() {
            const sale = salesManager.sales.find(s => s.id === salesManager.currentSaleId);
            const customer = sale?.customer;
            
            // Calculate total
            const total = salesManager.currentTransactions.reduce((sum, transaction) => {
                return sum + (transaction.quantity * transaction.price);
            }, 0);
            
            // Add print header
            const printHeader = document.createElement('div');
            printHeader.className = 'print-header';
            printHeader.innerHTML = `
                <h1>Sistem Koperasi - Detail Penjualan</h1>
                <p>Invoice #${sale?.id || ''}</p>
                <p>Tanggal: ${sale ? UIUtils.formatDateTime(sale.tgl_sales) : ''}</p>
                <p>Customer: ${customer?.nama || 'N/A'}</p>
            `;
            
            // Add print footer
            const printFooter = document.createElement('div');
            printFooter.className = 'print-footer';
            printFooter.innerHTML = `
                <p><strong>Total: ${UIUtils.formatCurrency(total)}</strong></p>
                <p>Dicetak pada: ${new Date().toLocaleString('id-ID')}</p>
            `;
            
            // Insert elements for print
            const modalBody = document.querySelector('#saleDetailModal .modal-body');
            const modalContent = document.querySelector('#saleDetailModal .modal-content');
            
            modalContent.insertBefore(printHeader, modalBody);
            modalContent.appendChild(printFooter);
            
            // Print
            window.print();
            
            // Remove print elements after printing
            setTimeout(() => {
                printHeader.remove();
                printFooter.remove();
            }, 1000);
        }

        // Initialize sales manager
        let salesManager;
        document.addEventListener('DOMContentLoaded', () => {
            salesManager = new SalesManager();
        });
    </script>
</body>
</html>
