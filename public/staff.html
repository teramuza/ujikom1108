<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Petugas - Sistem Koperasi</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="assets/css/all.min.css">
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-store"></i> Koperasi</h2>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li><a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="customers.html"><i class="fas fa-users"></i> Customer</a></li>
                <li><a href="items.html"><i class="fas fa-box"></i> Item</a></li>
                <li><a href="staff.html"><i class="fas fa-user-tie"></i> Petugas</a></li>
                <li><a href="sales.html"><i class="fas fa-shopping-cart"></i> Penjualan</a></li>
            </ul>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>Manajemen Petugas</h1>
            </div>
            <div class="header-right">
                <div class="user-info">
                </div>
            </div>
        </header>

        <!-- Content -->
        <main class="content">
            <!-- Staff List Card -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-user-tie"></i> Daftar Petugas</h3>
                    <button class="btn btn-primary" onclick="showAddStaffModal()">
                        <i class="fas fa-plus"></i> Tambah Petugas
                    </button>
                </div>
                <div class="card-body">
                    <div id="staffTable">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin"></i> Memuat data...
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Staff Modal -->
    <div id="staffModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="modalTitle">Tambah Petugas</h4>
                <button class="close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="staffForm">
                    <input type="hidden" id="staffId" name="id">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="name" class="form-label">Nama Lengkap</label>
                            <input type="text" id="name" name="name" class="form-control" placeholder="Masukkan nama lengkap" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" id="username" name="username" class="form-control" placeholder="Masukkan username" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" id="password" name="password" class="form-control" placeholder="Masukkan password" required>
                            <small class="form-text">Minimal 6 karakter</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="level" class="form-label">Level</label>
                            <select id="level" name="level" class="form-control" required>
                                <option value="">Pilih Level</option>
                                <option value="0">Sales</option>
                                <option value="1">Pengawas</option>
                                <option value="2">Manajer</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmPassword" class="form-label">Konfirmasi Password</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" placeholder="Ulangi password" required>
                    </div>
                    
                    <div class="alert alert-info" style="font-size: 14px;">
                        <strong>Level Keterangan:</strong><br>
                        <i class="fas fa-crown"></i> Administrator (1): Akses penuh ke semua fitur<br>
                        <i class="fas fa-user-cog"></i> Staff (2): Akses manajemen customer, item, dan penjualan<br>
                        <i class="fas fa-cash-register"></i> Kasir (3): Akses penjualan dan laporan
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="UIUtils.hideModal('staffModal')">Batal</button>
                <button type="submit" form="staffForm" class="btn btn-primary" id="saveBtn">
                    <i class="fas fa-save"></i> Simpan
                </button>
            </div>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script>
        // Staff management class
        class StaffManager {
            constructor() {
                this.staff = [];
                this.currentStaffId = null;
                this.init();
            }

            async init() {
                await this.loadStaff();
                this.initEventListeners();
            }

            initEventListeners() {
                // Form submission
                document.getElementById('staffForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveStaff();
                });

                // Password validation
                const password = document.getElementById('password');
                const confirmPassword = document.getElementById('confirmPassword');
                
                confirmPassword.addEventListener('input', () => {
                    if (password.value !== confirmPassword.value) {
                        confirmPassword.setCustomValidity('Password tidak cocok');
                    } else {
                        confirmPassword.setCustomValidity('');
                    }
                });

                // Username validation
                document.getElementById('username').addEventListener('input', (e) => {
                    const username = e.target.value;
                    if (username.length > 0 && username.length < 3) {
                        e.target.setCustomValidity('Username minimal 3 karakter');
                    } else {
                        e.target.setCustomValidity('');
                    }
                });

                // Password length validation
                password.addEventListener('input', (e) => {
                    if (e.target.value.length > 0 && e.target.value.length < 6) {
                        e.target.setCustomValidity('Password minimal 6 karakter');
                    } else {
                        e.target.setCustomValidity('');
                    }
                });
            }

            async loadStaff() {
                try {
                    this.staff = await ApiUtils.get('/petugas') || [];
                    this.renderStaffTable();
                } catch (error) {
                    console.error('Error loading staff:', error);
                    UIUtils.showError('Gagal memuat data petugas');
                }
            }

            renderStaffTable() {
                const columns = [
                    { field: 'id', title: 'ID' },
                    { field: 'name', title: 'Nama' },
                    { field: 'username', title: 'Username' },
                    {
                        field: 'level',
                        title: 'Level',
                        render: (value) => {
                            const levels = {
                                0: '<span class="badge badge-info"><i class="fas fa-user"></i> Sales</span>',
                                1: '<span class="badge badge-warning"><i class="fas fa-user-shield"></i> Pengawas</span>',
                                2: '<span class="badge badge-primary"><i class="fas fa-crown"></i> Manajer</span>'
                            };
                            return levels[value] || value;
                        }
                    },
                    {
                        field: 'createdAt',
                        title: 'Dibuat',
                        render: (value) => value ? UIUtils.formatDate(value) : 'N/A'
                    },
                    {
                        field: 'actions',
                        title: 'Aksi',
                        render: (value, row) => `
                            <div class="actions">
                                <button class="btn btn-sm btn-warning" onclick="staffManager.editStaff(${row.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="staffManager.deleteStaff(${row.id})" 
                                        ${row.id === 1 ? 'disabled title="Tidak dapat menghapus admin utama"' : ''}>
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `
                    }
                ];

                // Badge styles are now in main CSS file

                TableUtils.renderTable('staffTable', this.staff, columns);
            }

            async saveStaff() {
                const form = document.getElementById('staffForm');
                
                if (!FormUtils.validate(form)) {
                    UIUtils.showError('Harap lengkapi semua field yang diperlukan');
                    return;
                }

                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (password !== confirmPassword) {
                    UIUtils.showError('Password dan konfirmasi password tidak cocok');
                    return;
                }

                if (password.length < 6) {
                    UIUtils.showError('Password minimal 6 karakter');
                    return;
                }

                const username = document.getElementById('username').value;
                if (username.length < 3) {
                    UIUtils.showError('Username minimal 3 karakter');
                    return;
                }

                // Check if username already exists (except for current user when editing)
                const existingUser = this.staff.find(s => 
                    s.username === username && s.id !== this.currentStaffId
                );
                if (existingUser) {
                    UIUtils.showError('Username sudah digunakan');
                    return;
                }

                const data = FormUtils.serialize(form);
                // Remove confirmPassword from submission
                delete data.confirmPassword;
                
                try {
                    // Show loading
                    const saveBtn = document.getElementById('saveBtn');
                    const originalText = saveBtn.innerHTML;
                    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
                    saveBtn.disabled = true;

                    let response;
                    if (this.currentStaffId) {
                        // Update existing staff
                        response = await ApiUtils.put(`/petugas/${this.currentStaffId}`, data);
                    } else {
                        // Create new staff (register)
                        response = await ApiUtils.post('/petugas/register', data);
                    }

                    if (response) {
                        UIUtils.showSuccess(this.currentStaffId ? 'Petugas berhasil diperbarui' : 'Petugas berhasil ditambahkan');
                        UIUtils.hideModal('staffModal');
                        this.resetForm();
                        await this.loadStaff();
                    }
                } catch (error) {
                    console.error('Error saving staff:', error);
                    UIUtils.showError('Gagal menyimpan petugas');
                } finally {
                    // Reset button
                    const saveBtn = document.getElementById('saveBtn');
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Simpan';
                    saveBtn.disabled = false;
                }
            }

            editStaff(id) {
                const staff = this.staff.find(s => s.id === id);
                if (!staff) return;

                this.currentStaffId = id;
                document.getElementById('modalTitle').textContent = 'Edit Petugas';
                
                const form = document.getElementById('staffForm');
                FormUtils.populate(form, staff);
                
                // Clear password fields for security
                document.getElementById('password').value = '';
                document.getElementById('confirmPassword').value = '';
                
                // Make password optional for edit
                document.getElementById('password').required = false;
                document.getElementById('confirmPassword').required = false;
                
                UIUtils.showModal('staffModal');
            }

            async deleteStaff(id) {
                if (id === 1) {
                    UIUtils.showError('Tidak dapat menghapus admin utama');
                    return;
                }

                const staff = this.staff.find(s => s.id === id);
                if (!staff) return;

                if (!UIUtils.confirmDelete(`Hapus petugas "${staff.name}"?`)) {
                    return;
                }

                try {
                    await ApiUtils.delete(`/petugas/${id}`);
                    UIUtils.showSuccess('Petugas berhasil dihapus');
                    await this.loadStaff();
                } catch (error) {
                    console.error('Error deleting staff:', error);
                    UIUtils.showError('Gagal menghapus petugas');
                }
            }

            resetForm() {
                this.currentStaffId = null;
                document.getElementById('modalTitle').textContent = 'Tambah Petugas';
                FormUtils.reset(document.getElementById('staffForm'));
                
                // Reset password requirements
                document.getElementById('password').required = true;
                document.getElementById('confirmPassword').required = true;
            }
        }

        // Global functions
        function showAddStaffModal() {
            staffManager.resetForm();
            UIUtils.showModal('staffModal');
        }

        // Initialize staff manager
        let staffManager;
        document.addEventListener('DOMContentLoaded', () => {
            staffManager = new StaffManager();
        });
    </script>
</body>
</html>
